{% extends "base.html" %}
{% block title %}Desempenho — VestibulandoBot{% endblock %}

{% block content %}
<h2 class="page-title">Seu desempenho</h2>

{% if total == 0 %}
  <div class="card">
    <p>Você ainda não respondeu questões.</p>
    <div class="actions">
      <a class="btn" href="{{ url_for('desafio') }}">Ir para Modo Desafio</a>
      <a class="btn btn-ghost" href="{{ url_for('estudo') }}">Ir para Modo Estudo</a>
    </div>
  </div>
{% else %}
  <div class="kpis">
    <div class="kpi card">
      <span class="kpi-label">Respondidas</span>
      <span class="kpi-value">{{ total }}</span>
    </div>
    <div class="kpi card">
      <span class="kpi-label">Acertos</span>
      <span class="kpi-value">{{ acertos }}</span>
    </div>
    <div class="kpi card">
      <span class="kpi-label">Precisão</span>
      <span class="kpi-value">{{ percentual }}%</span>
    </div>
  </div>

  <div class="card">
    <h3>Por ano</h3>
    <div class="bars">
      {% for linha in por_ano %}
      <div class="bar-row">
        <div class="bar-label">Ano {{ linha.ano }}</div>
        <div class="bar">
          <!-- em vez de style="width: {{ linha.percentual }}%" usamos data-pct -->
          <div class="bar-fill" data-pct="{{ linha.percentual|float }}"></div>
        </div>
        <div class="bar-meta">{{ linha.acertos }}/{{ linha.total }} ({{ linha.percentual }}%)</div>
      </div>
      {% endfor %}
    </div>
  </div>

  {% if por_assunto is defined %}
  <div class="card">
    <h3>Por assunto</h3>
    <div class="bars">
      {% for a in por_assunto %}
      <div class="bar-row">
        <div class="bar-label">{{ a.assunto }}</div>
        <div class="bar">
          <div class="bar-fill" data-pct="{{ a.percentual|float }}"></div>
        </div>
        <div class="bar-meta">{{ a.acertos }}/{{ a.total }} ({{ a.percentual }}%)</div>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  {% if sugestoes is defined %}
  <div class="card">
    <h3>Sugestões de estudo</h3>
    {% if sugestoes %}
      <ol class="suggest-list">
        {% for s in sugestoes %}
        <li><b>{{ s.assunto }}</b> — {{ s.percentual }}% de acerto ({{ s.acertos }}/{{ s.total }})</li>
        {% endfor %}
      </ol>
      <p class="muted small">* Baseado nos assuntos com menor % (min. 2 questões).</p>
    {% else %}
      <p>Responda mais questões para gerarmos sugestões personalizadas.</p>
    {% endif %}
  </div>
  {% endif %}
{% endif %}
{% endblock %}

{% block scripts %}
<script>
(function(){
  // aplica largura das barras lendo o data-pct (evita Jinja dentro de CSS)
  var fills = document.querySelectorAll('.bar-fill[data-pct]');
  fills.forEach(function(el){
    var pct = parseFloat(el.getAttribute('data-pct'));
    if (!isFinite(pct)) pct = 0;
    if (pct < 0) pct = 0;
    if (pct > 100) pct = 100;
    el.style.width = pct + '%';
    el.setAttribute('aria-valuenow', pct);
  });
})();
</script>
{% endblock %}
